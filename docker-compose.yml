version: '3.8'

services:
  # Portainer - Docker management UI
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9443:9443"
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    environment:
      - TZ=Europe/Madrid
    networks:
      - homelab

  # WireGuard VPN with wg-easy UI
  wireguard:
    image: ghcr.io/wg-easy/wg-easy:latest
    container_name: wireguard
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    ports:
      - "51820:51820/udp"  # WireGuard VPN
      - "51821:51821/tcp"  # Web UI
    volumes:
      - wireguard_data:/etc/wireguard
    environment:
      - WG_HOST=${WG_HOST:-tu-dns-o-ip-publica.duckdns.org}
      - PASSWORD=${WG_PASSWORD:-cambiar-password-seguro}
      - WG_DEFAULT_ADDRESS=10.10.10.x
      - WG_DEFAULT_DNS=1.1.1.1
      - WG_ALLOWED_IPS=192.168.18.0/24,10.10.10.0/24
      - TZ=Europe/Madrid
    networks:
      - homelab

  # Nginx Proxy Manager (opcional) - para reverse proxy con SSL
  nginx-proxy:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    restart: unless-stopped
    ports:
      - "80:80"     # HTTP
      - "443:443"   # HTTPS
      - "81:81"     # Admin UI
    volumes:
      - nginx_data:/data
      - nginx_letsencrypt:/etc/letsencrypt
    environment:
      - TZ=Europe/Madrid
    networks:
      - homelab

volumes:
  portainer_data:
  wireguard_data:
  nginx_data:
  nginx_letsencrypt:

networks:
  homelab:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
